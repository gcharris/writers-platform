# Phase 2: Community Platform Migration - Testing Guide

**Status**: ðŸ“‹ Ready for Testing
**Created**: 2025-01-18
**Implementation Commit**: 7dcdb20

---

## Prerequisites

Before testing, ensure:
- âœ… Backend running locally or deployed to Railway
- âœ… Frontend running locally or deployed to Vercel
- âœ… PostgreSQL database accessible
- âœ… Factory platform accessible (for cross-platform testing)

---

## Step 1: Database Migration

### 1.1 Run Migration

**Local Testing:**
```bash
# Connect to your local PostgreSQL
psql -U postgres -d writers_platform

# Run the migration
\i backend/migrations/add_community_badges.sql

# Verify tables created
\dt badges
\d badges
\d works
```

**Railway/Production:**
```bash
# Option 1: Via Railway CLI
railway run psql -c "\i backend/migrations/add_community_badges.sql"

# Option 2: Via Railway web console
# Go to Railway > PostgreSQL > Data
# Copy and paste contents of add_community_badges.sql
```

### 1.2 Verify Migration

```sql
-- Check badges table exists
SELECT table_name
FROM information_schema.tables
WHERE table_name = 'badges';

-- Check work model has new fields
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'works'
AND column_name IN ('factory_project_id', 'factory_scores');

-- Verify indexes created
SELECT indexname FROM pg_indexes WHERE tablename = 'badges';
```

**Expected Output:**
```
table_name
-----------
badges

column_name          | data_type
---------------------|----------
factory_project_id   | uuid
factory_scores       | jsonb

indexname
--------------------------
idx_badges_work_id
idx_badges_type
idx_badges_verified
idx_badges_metadata_gin
```

---

## Step 2: Backend API Testing

### 2.1 Test Badge Assignment on Upload

**Test 1: Upload WITHOUT human authorship claim**

```bash
# Expected: community_upload badge
curl -X POST "http://localhost:8000/api/works/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Test Story 1",
    "content": "This is a test story content...",
    "genre": "Science Fiction",
    "summary": "A test story",
    "content_rating": "PG"
  }'
```

**Expected Response:**
```json
{
  "id": "uuid-123",
  "title": "Test Story 1",
  "badges": [
    {
      "badge_type": "community_upload",
      "verified": false,
      "metadata_json": {}
    }
  ],
  "factory_project_id": null,
  "factory_scores": null
}
```

**Test 2: Upload WITH human authorship claim**

```bash
# Expected: human_verified or human_self badge
curl -X POST "http://localhost:8000/api/works/?claim_human_authored=true" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "My Human-Written Story",
    "content": "I wrote this myself. It has a personal voice, varied sentence structures, and authentic imperfections. I love writing!",
    "genre": "Literary Fiction",
    "summary": "A personal story"
  }'
```

**Expected Response:**
```json
{
  "id": "uuid-456",
  "title": "My Human-Written Story",
  "badges": [
    {
      "badge_type": "human_verified",  // or "human_self" if confidence < 80%
      "verified": true,
      "metadata_json": {
        "confidence": 0.85,
        "detection_model": "heuristic",
        "note": "Verified via AI detection"
      }
    }
  ]
}
```

**Test 3: Upload AI-generated content WITH human claim**

```bash
# Expected: community_upload badge (AI detected)
curl -X POST "http://localhost:8000/api/works/?claim_human_authored=true" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "AI-Generated Test",
    "content": "It is important to note that this content was generated by AI. Furthermore, it is worth noting that AI-generated text often has these patterns. Moreover, it is crucial to understand...",
    "genre": "Non-Fiction",
    "summary": "Test AI detection"
  }'
```

**Expected Response:**
```json
{
  "badges": [
    {
      "badge_type": "community_upload",
      "verified": false,
      "metadata_json": {
        "note": "AI authorship detected",
        "confidence": 0.75,
        "detection_method": "heuristic"
      }
    }
  ]
}
```

### 2.2 Test Factory â†’ Community Publishing

**Test 4: Publish from Factory**

First, create a Factory project and optionally run analysis on it. Then:

```bash
# Replace {factory_project_id} with actual UUID
curl -X POST "http://localhost:8000/api/works/from-factory/{factory_project_id}?title=My%20Factory%20Story&summary=Published%20from%20Factory" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Expected Response:**
```json
{
  "id": "uuid-789",
  "title": "My Factory Story",
  "factory_project_id": "uuid-project-123",
  "factory_scores": {
    "best_score": 72,
    "hybrid_score": 75,
    "total_cost": 0.42
  },
  "badges": [
    {
      "badge_type": "ai_analyzed",
      "verified": true,
      "metadata_json": {
        "score": 72,
        "best_agent": "claude-sonnet-4.5",
        "hybrid_score": 75,
        "models_used": ["claude", "gemini", "gpt", "grok", "deepseek"],
        "factory_project_id": "uuid-project-123",
        "analysis_cost": 0.42
      }
    }
  ]
}
```

### 2.3 Test Badge Filtering in Browse

**Test 5: Filter by badge type**

```bash
# Get all AI-analyzed works
curl "http://localhost:8000/api/browse/works?badge_type=ai_analyzed"

# Get all human-verified works
curl "http://localhost:8000/api/browse/works?badge_type=human_verified"

# Get all works (no filter)
curl "http://localhost:8000/api/browse/works"
```

**Expected Response:**
```json
{
  "works": [
    {
      "id": "uuid-789",
      "title": "My Factory Story",
      "badges": [{"badge_type": "ai_analyzed", ...}]
    }
  ],
  "total": 1,
  "page": 1,
  "page_size": 20
}
```

### 2.4 Test Combined Filters

**Test 6: Badge + Genre filter**

```bash
# AI-analyzed Science Fiction works
curl "http://localhost:8000/api/browse/works?badge_type=ai_analyzed&genre=Science%20Fiction"

# Human-verified Romance works
curl "http://localhost:8000/api/browse/works?badge_type=human_verified&genre=Romance"
```

---

## Step 3: Frontend Testing

### 3.1 Test Browse Page Badge Filter

**Manual Test:**
1. Navigate to `http://localhost:3001/browse` (or your Community frontend URL)
2. Click the "Badge Type" dropdown
3. Select "AI-Analyzed"
4. **Expected**: Only works with ai_analyzed badge appear
5. Select "Human-Verified"
6. **Expected**: Only works with human_verified badge appear
7. Select "All Badges"
8. **Expected**: All works appear

**Screenshot Checklist:**
- [ ] Badge filter dropdown visible
- [ ] All 4 badge types in dropdown (ai_analyzed, human_verified, human_self, community_upload)
- [ ] Works filtered correctly when badge selected
- [ ] Badge chips displayed on work cards

### 3.2 Test ViewWork Knowledge Graph Tab

**Test 7: View AI-Analyzed Work**

1. Create/publish a Factory project with Knowledge Graph extracted
2. Publish to Community via `/api/works/from-factory/{project_id}`
3. Navigate to `http://localhost:3001/works/{work_id}`

**Expected:**
- [ ] Two tabs visible: "Read Story" and "Explore Knowledge Graph"
- [ ] "Read Story" tab active by default
- [ ] Click "Explore Knowledge Graph" tab
- [ ] Blue info box explaining AI-generated graph
- [ ] Link to Factory for full interactive graph
- [ ] Knowledge Graph visualization or placeholder appears

**Test 8: View Community Upload (No Factory Link)**

1. Upload a work directly via Community `/api/works/`
2. Navigate to work page

**Expected:**
- [ ] NO tabs visible (only Read Story content)
- [ ] Knowledge Graph tab does NOT appear
- [ ] Factory CTA in sidebar: "Want Professional Feedback?"

### 3.3 Test Upload Page Copilot CTA

**Test 9: Upload Page**

1. Navigate to `http://localhost:3001/upload`

**Expected:**
- [ ] Header says "Upload your manuscript or write with FREE AI assistance"
- [ ] Prominent purple/blue gradient section at top
- [ ] "âœ¨ NEW: Write with FREE AI Copilot" heading
- [ ] Description mentions real-time suggestions and Ollama
- [ ] "Start Writing with Copilot" button links to Factory
- [ ] "Or Upload Existing File" button scrolls to upload section
- [ ] File upload section below with drag-and-drop

---

## Step 4: End-to-End Workflows

### Workflow 1: Factory â†’ Community Publication

**Steps:**
1. Create project in Factory (`http://localhost:3000`)
2. Add scenes with content
3. Run Knowledge Graph extraction (optional)
4. Run 5-model analysis (optional)
5. Publish to Community via API or Factory UI (if implemented)
6. Navigate to Community browse page
7. Find published work
8. Click to view work

**Expected:**
- [ ] Work appears in Community browse
- [ ] ai_analyzed badge displayed
- [ ] Factory scores visible (if analysis run)
- [ ] Knowledge Graph tab appears
- [ ] Can switch between Read and Graph tabs
- [ ] Factory link in sidebar works

### Workflow 2: Direct Community Upload

**Steps:**
1. Navigate to Community Upload page
2. Upload .txt/.docx/.pdf file
3. Fill in title, genre, description
4. Check "This work was written entirely by me" checkbox
5. Click "Publish to Community"
6. Wait for processing
7. View published work

**Expected:**
- [ ] Work uploaded successfully
- [ ] Badge assigned (human_verified, human_self, or community_upload)
- [ ] Work appears in browse
- [ ] NO Knowledge Graph tab (no Factory project)
- [ ] Factory CTA in sidebar

### Workflow 3: Browse and Discovery

**Steps:**
1. Navigate to Browse page
2. Select "AI-Analyzed" badge filter
3. Select "Science Fiction" genre
4. Sort by "Most Recent"
5. Click on a work

**Expected:**
- [ ] Only AI-analyzed sci-fi works appear
- [ ] Works sorted correctly
- [ ] Badge chips visible on cards
- [ ] Work page loads with correct badge
- [ ] Knowledge Graph tab visible (if from Factory)

---

## Step 5: Edge Cases & Error Testing

### Test 10: Invalid Factory Project ID

```bash
curl -X POST "http://localhost:8000/api/works/from-factory/00000000-0000-0000-0000-000000000000" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Expected:**
```json
{
  "detail": "Project not found or unauthorized"
}
```

### Test 11: Factory Project with No Scenes

```bash
# Create empty project, try to publish
curl -X POST "http://localhost:8000/api/works/from-factory/{empty_project_id}" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Expected:**
```json
{
  "detail": "Project has no scenes to publish"
}
```

### Test 12: Unauthorized Access

```bash
# Try to publish someone else's Factory project
curl -X POST "http://localhost:8000/api/works/from-factory/{other_users_project_id}" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Expected:**
```json
{
  "detail": "Project not found or unauthorized"
}
```

---

## Step 6: Database Verification

### Test 13: Verify Badge Records

```sql
-- Check all badges created
SELECT
  b.badge_type,
  b.verified,
  w.title,
  b.metadata_json->>'confidence' as confidence,
  b.metadata_json->>'factory_project_id' as factory_id
FROM badges b
JOIN works w ON b.work_id = w.id
ORDER BY b.created_at DESC;
```

**Expected Output:**
```
badge_type       | verified | title              | confidence | factory_id
-----------------|----------|--------------------|-----------|-----------
ai_analyzed      | t        | My Factory Story   |            | uuid-123
human_verified   | t        | Human Story        | 0.85       |
community_upload | f        | Test Upload        |            |
```

### Test 14: Verify Factory Links

```sql
-- Check works linked to Factory projects
SELECT
  w.title,
  w.factory_project_id,
  w.factory_scores->>'best_score' as score,
  w.factory_scores->>'hybrid_score' as hybrid
FROM works w
WHERE w.factory_project_id IS NOT NULL;
```

---

## Step 7: Performance Testing

### Test 15: Badge Filter Performance

```bash
# Test with 1000+ works
# Measure query time with badge filter
curl "http://localhost:8000/api/browse/works?badge_type=ai_analyzed&page=1&page_size=20"
```

**Expected:**
- Response time < 500ms
- Correct pagination
- Indexes used (check EXPLAIN ANALYZE)

### Test 16: Knowledge Graph Load Time

1. Navigate to work with large Knowledge Graph (50+ entities)
2. Click "Explore Knowledge Graph" tab
3. Measure load time

**Expected:**
- Tab switch < 200ms
- Graph visualization loads < 1s
- No browser console errors

---

## Test Results Checklist

### Backend âœ…
- [ ] Database migration successful
- [ ] Badge table created with indexes
- [ ] Works table updated with Factory fields
- [ ] Badge assignment works for all 4 types
- [ ] AI detection assigns correct badge
- [ ] Factory publishing creates ai_analyzed badge
- [ ] Badge filtering in browse works
- [ ] Combined filters work (badge + genre)
- [ ] Error handling works (404, 401, 400)

### Frontend âœ…
- [ ] Browse badge filter functional
- [ ] Knowledge Graph tab appears for Factory works
- [ ] Knowledge Graph tab hidden for Community uploads
- [ ] Upload page shows Copilot CTA
- [ ] Badge chips displayed correctly
- [ ] Factory CTAs work
- [ ] Mobile responsive (test on phone)

### Integration âœ…
- [ ] Factory â†’ Community publication complete
- [ ] Knowledge Graph accessible from Community
- [ ] Badges preserve metadata
- [ ] Analysis scores transferred
- [ ] Direct upload works end-to-end
- [ ] All 4 badge types can be created

---

## Known Issues & Limitations

**Current Limitations:**
1. AI detection uses heuristics only (no paid API integration yet)
2. Knowledge Graph visualization is placeholder (links to Factory)
3. No batch publishing (one project at a time)
4. No badge appeals/verification override UI

**Future Enhancements:**
- Integrate GPTZero or Copyleaks for better AI detection
- Embed actual 3D graph visualization in Community
- Add batch Factory â†’ Community publishing
- Add admin panel for badge verification

---

## Deployment Checklist

### Pre-Deploy
- [ ] All tests passing locally
- [ ] Database migration tested on staging
- [ ] No console errors in browser
- [ ] API endpoints documented
- [ ] Environment variables set

### Deploy
- [ ] Run migration on production database
- [ ] Deploy backend to Railway
- [ ] Deploy frontend to Vercel
- [ ] Test production endpoints
- [ ] Monitor error logs

### Post-Deploy
- [ ] Smoke test all workflows
- [ ] Monitor badge assignment rates
- [ ] Check database performance
- [ ] Verify Factory integration
- [ ] Collect user feedback

---

## Troubleshooting

### Issue: Badge not assigned on upload
**Solution:** Check console logs for BadgeEngine errors. Verify work was flushed before badge creation.

### Issue: Knowledge Graph tab not appearing
**Solution:** Verify work has `factory_project_id` set. Check React DevTools for work object.

### Issue: Badge filter returns no results
**Solution:** Verify JOIN in browse query. Check that badges exist in database.

### Issue: Factory publishing fails
**Solution:** Verify project ownership, check scenes exist, ensure analysis_result relationship works.

---

**Testing Complete!**

Once all tests pass, Phase 2 is ready for production deployment.

Next: Monitor analytics for Community adoption and badge distribution.
